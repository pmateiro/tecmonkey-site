<section id="contato" class="alt">
      <div class="container">
        <h2 class="section-title reveal">Contato</h2>
        <p class="section-desc reveal">
          Teste abaixo um mini chat que consulta seu endpoint (Worker).
        </p>

        <div class="chatbox reveal">
          <h3 style="margin:0 0 10px;">Chat (IA)</h3>

          <div id="chat-messages" class="chat-messages">
            <div style="color:#b7c3df; padding: 10px;">Digite uma pergunta para testar o agente.</div>
          </div>

          <form id="chat-form" class="chat-form">
            <input id="chat-input" class="chat-input" type="text" placeholder="Ex: O que é um chatbot?" autocomplete="off" required>
            <button id="chat-send" class="btn primary" type="submit">Enviar</button>
          </form>

          <div id="chat-status" class="chat-status" style="min-height: 20px;"></div>
        </div>
      </div>
    </section>
  </main>

  <footer>
    TecMonkey Serviços de Software Ltda<br>
    CNPJ: 37.123.698/0001-42
  </footer>

  <script>
    // 1. Scroll reveal robusto
    const els = document.querySelectorAll('.reveal');
    const observerOptions = { threshold: 0.1, rootMargin: "0px 0px -50px 0px" };
    
    const io = new IntersectionObserver((entries) => {
      entries.forEach((e) => {
        if (e.isIntersecting) {
            e.target.classList.add('show');
        }
      });
    }, observerOptions);
    
    els.forEach(el => io.observe(el));

    // 2. Configurações do Chat
    const ENDPOINT = "https://bobcrock.pmateiro.workers.dev/";
    const form = document.getElementById("chat-form");
    const input = document.getElementById("chat-input");
    const sendBtn = document.getElementById("chat-send");
    const messages = document.getElementById("chat-messages");
    const statusEl = document.getElementById("chat-status");

    function addMsg(role, text) {
      const wrap = document.createElement("div");
      wrap.style.margin = "12px 0";
      wrap.style.padding = "12px";
      wrap.style.borderRadius = "12px";
      wrap.style.border = "1px solid rgba(255,255,255,.08)";
      wrap.style.background = role === "user" 
        ? "rgba(77,163,255,0.15)" 
        : "rgba(255,255,255,0.05)";
      wrap.style.alignSelf = role === "user" ? "flex-end" : "flex-start";

      const who = document.createElement("div");
      who.style.fontSize = "0.75rem";
      who.style.fontWeight = "600";
      who.style.color = role === "user" ? "#4da3ff" : "#b7c3df";
      who.style.marginBottom = "4px";
      who.textContent = role === "user" ? "VOCÊ" : "TEC MONKEY IA";

      const body = document.createElement("div");
      body.style.whiteSpace = "pre-wrap";
      body.style.fontSize = "0.95rem";
      body.textContent = text;

      wrap.appendChild(who);
      wrap.appendChild(body);
      messages.appendChild(wrap);
      messages.scrollTop = messages.scrollHeight;
    }

    async function askLLM(prompt) {
      const url = `${ENDPOINT}?prompt=${encodeURIComponent(prompt)}`;
      
      const res = await fetch(url, { 
        method: "GET",
        headers: { "Accept": "application/json" }
      });

      if (!res.ok) {
        throw new Error(`Erro: ${res.status}`);
      }

      const data = await res.json();
      console.log("Resposta do Worker:", data);

      // Lógica de extração de texto adaptada
      if (typeof data === 'string') return data;
      return data.response || data.output || data.result || JSON.stringify(data);
    }

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const prompt = input.value.trim();
      if (!prompt) return;

      // Limpar placeholder inicial se for a primeira mensagem
      if (messages.children.length === 1 && messages.innerText.includes("Digite uma pergunta")) {
          messages.innerHTML = '';
      }

      addMsg("user", prompt);
      input.value = "";
      statusEl.textContent = "Processando resposta...";
      sendBtn.disabled = true;

      try {
        const answer = await askLLM(prompt);
        addMsg("assistant", answer);
        statusEl.textContent = "";
      } catch (err) {
        console.error("Erro na requisição:", err);
        statusEl.textContent = "Erro na conexão.";
        addMsg("assistant", "⚠️ Não foi possível obter resposta. Verifique se o Worker permite conexões (CORS).");
      } finally {
        sendBtn.disabled = false;
        input.focus();
      }
    });
  </script>
